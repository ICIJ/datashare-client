<script setup>
import { computed, ref } from 'vue'

import PageTableGeneric from '@/components/PageTable/PageTableGeneric'
import { useTaskPolling } from '@/composables/task-polling'
import DisplayProgress from '@/components/Display/DisplayProgress'
import DisplayStatus from '@/components/Display/DisplayStatus'
import DisplayDatetimeFromNow from '@/components/Display/DisplayDatetimeFromNow'
import DisplayUser from '@/components/Display/DisplayUser'
import { getHumanTaskName, TASK_NAME, TASK_NAME_ICON } from '@/enums/taskNames'
import ButtonIcon from '@/components/Button/ButtonIcon'
import DisplayProjectList from '@/components/Display/DisplayProjectList'
import useMode from '@/composables/mode'
import TaskBatchDownloadLink from '@/components/Task/TaskBatchDownload/TaskBatchDownloadLink'
import TaskBatchSearchLink from '@/components/Task/TaskBatchSearch/TaskBatchSearchLink'

const nbTasks = ref(3)
const { tasks: pollingTasks, isLoading } = useTaskPolling()
const { isServer } = useMode()

const allFields = ref([
  {
    name: 'name',
    value: 'name',
    text: 'Task',
    icon: 'rocket-launch'
  },
  {
    name: 'state',
    value: 'state',
    text: 'State',
    icon: ''
  },
  {
    name: 'title',
    value: 'title',
    text: 'Name',
    emphasis: true,
    icon: ''
  },
  {
    name: 'projects',
    value: 'projects',
    text: 'Projects',
    icon: 'circles-three-plus'
  },
  {
    name: 'author',
    value: 'author',
    text: 'Author',
    icon: 'user'
  },
  {
    name: 'createdAt',
    value: 'createdAt',
    text: 'Creation date',
    icon: 'user'
  },
  {
    name: 'progress',
    value: 'progress',
    text: 'Progress',
    icon: 'user'
  }
])

const fields = computed(() => allFields.value.filter((p) => isServer.value || p.name !== 'author'))

const more = 3

function showMore() {
  nbTasks.value += more
}

const displayedTasks = computed(() => pollingTasks.value?.slice(0, nbTasks.value))

const hideShowMore = computed(() => {
  return !pollingTasks.value?.length || pollingTasks.value.length <= nbTasks.value
})

function getAuthor(item) {
  if (item.args?.batchDownload) {
    return item.args?.batchDownload.user.id
  }
  return item.args?.user.id
}

function getProjects(item) {
  switch (item.name) {
    case TASK_NAME.BATCH_DOWNLOAD:
      return item.args?.batchDownload.projects
    case TASK_NAME.BATCH_SEARCH:
      return item.args?.batchRecord?.projects
    case TASK_NAME.EXTRACT_NLP:
    case TASK_NAME.ENQUEUE_FROM_INDEX:
    case TASK_NAME.SCAN:
    case TASK_NAME.INDEX:
      return [item.args?.defaultProject]
    default:
      console.error('Unknown task', item)
      return []
  }
}

function getTitle(item) {
  switch (item.name) {
    case TASK_NAME.BATCH_SEARCH:
      return item.args?.batchRecord?.name
    case TASK_NAME.BATCH_DOWNLOAD:
      return item.args?.batchDownload?.filename
    case TASK_NAME.SCAN:
    case TASK_NAME.INDEX:
    case TASK_NAME.ENQUEUE_FROM_INDEX:
    case TASK_NAME.EXTRACT_NLP:
    default:
      return getHumanTaskName(item.name)
  }
}

function getTaskLinkTitle(item) {
  switch (item.name) {
    case TASK_NAME.BATCH_SEARCH:
      return 'Batch search task'
    case TASK_NAME.BATCH_DOWNLOAD:
      return 'Batch download task'
    case TASK_NAME.INDEX:
    case TASK_NAME.SCAN:
      return 'Document task'
    case TASK_NAME.ENQUEUE_FROM_INDEX:
    case TASK_NAME.EXTRACT_NLP:
      return 'Entity task'
    default:
      return 'Unknown task'
  }
}

function getTaskLinkRoute(item) {
  switch (item.name) {
    case TASK_NAME.BATCH_SEARCH:
      return { name: 'task.batch-search.list' }
    case TASK_NAME.BATCH_DOWNLOAD:
      return { name: 'task.batch-download.list' }
    case TASK_NAME.INDEX:
    case TASK_NAME.SCAN:
      return { name: 'task.documents.list' }
    case TASK_NAME.ENQUEUE_FROM_INDEX:
    case TASK_NAME.EXTRACT_NLP:
      return { name: 'task.entities.list' }
    default:
      return null
  }
}

function getTaskIcon(item) {
  return TASK_NAME_ICON[item.name]
}
</script>

<template>
  <b-card-body no-border class="task-all__latest no-border">
    <b-card-title class="pb-4">
      <phosphor-icon name="rocket-launch" />
      Latest tasks
    </b-card-title>
    <b-overlay rounded spinner-small opacity="0.6" :show="isLoading" class="d-flex flex-column justify-content-center">
      <page-table-generic :items="displayedTasks" :fields="fields">
        <template #cell(name)="{ item }">
          <button-icon
            :icon-left="getTaskIcon(item)"
            :label="getTaskLinkTitle(item)"
            :to="getTaskLinkRoute(item)"
            hide-label
            size="sm"
            square
            variant="outline-tertiary"
          />
        </template>
        <template #cell(state)="{ item }">
          <display-status size="sm" :value="item.state" />
        </template>
        <template #cell(title)="{ item }">
          <task-batch-download-link v-if="item.name === TASK_NAME.BATCH_DOWNLOAD" :item="item" />
          <task-batch-search-link v-else-if="item.name === TASK_NAME.BATCH_SEARCH" :item="item" />
          <span v-else> {{ getTitle(item) }}</span>
        </template>
        <template #cell(createdAt)="{ item }">
          <display-datetime-from-now :value="item.createdAt" />
        </template>
        <template #cell(author)="{ item }">
          <display-user :value="getAuthor(item)" />
        </template>
        <template #cell(projects)="{ item }">
          <display-project-list :values="getProjects(item)" />
        </template>
        <template #cell(progress)="{ item }">
          <display-progress :value="item.progress" />
        </template>
      </page-table-generic>
      <b-button v-if="!hideShowMore" variant="outline-secondary mx-auto" @click="showMore">Show more</b-button>
    </b-overlay>
  </b-card-body>
</template>

<style scoped lang="scss"></style>
